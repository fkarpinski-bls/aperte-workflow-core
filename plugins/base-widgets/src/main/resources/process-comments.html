<#if attributesProvider.processInstance??>
    <#assign processComments = attributesProvider.processInstance.getCommentsOrderedByDate(true) />
    <#assign internalId = task.internalTaskId />
</#if>
<#if !processComments??>
    <#assign commentsAttribute = attributesProvider.getAttribute('comments')!"" />
    <#if commentsAttribute?has_content>
        <#assign processComments = commentsAttribute.getCommentsOrderedByDate(true)! />
    <#else>
        <#assign processComments = [] />
    </#if>
    <#assign internalId = attributesProvider.id />
</#if>


<style type="text/css" media="all">
    .add-new-comment-input
    {
        margin-top: 10px;
        margin-bottom: 10px;
        width: 100%;
        min-height: 100px;
    }

    .add-comment-button
    {
        margin-top: 10px;
    }
</style>

<div>
    <div class="panel panel-default">
        <div class="panel-body form-inline">
            <ul class="list-group aperte-list-group" id="process_comments_list">
                <#list processComments as processComment>
                    <#assign substituteUser = processComment.substituteLogin!""/>
                    <li class="list-group-item">
                        <h4 class="list-group-item-heading">
                            ${processComment.authorFullName} (${processComment.authorLogin}) [${processComment.createTime?string("dd-MM-yy HH:mm")}]
                            <#if substituteUser != "">
                                ${messageSource.getMessage("process.history.subsituted.by")}
                                ${processComment.substituteFullName} (${processComment.substituteLogin})
                            </#if>
                        </h4>
                        <p class="list-group-item-text">
                            <#assign processCommentType = processComment.commentType!""/>
                            <#if processCommentType != "">
                                ${processCommentType}
                                <br>
                            </#if>
                            ${processComment.body}
                        </p>
                    </li>
                </#list>
            </ul>
            <#if privileges?seq_contains("EDIT")>
                <button class="btn btn-info add-comment-button" id="process_comments_button_new" onclick="process_comments_button_new_click()">${messageSource.getMessage("widget.process_comments.new")}</button>
                <div id="process_comments_add_form" style="display:none;">
                    <textarea id="process_comments_body" class="add-new-comment-input" style="display: block;"></textarea>
                    <button class="btn btn-info" id="process_comments_button_add" onclick="process_comments_button_add_click()">${messageSource.getMessage("widget.process_comments.add")}</button>
                    <button class="btn btn-warning" id="process_comments_button_cancel" onclick="process_comments_button_cancel_click()">${messageSource.getMessage("widget.process_comments.cancel")}</button>
                </div>
            </#if>
        </div>
    </div>
</div>



<#if privileges?seq_contains("EDIT")>
<script type="text/javascript">
    processCommentsAddedComments = [];

    $(document).ready(function()
    {
        //$('#area-comment-warning').hide();

        var widget = new Widget('${widgetName}', '${widgetId}', '${internalId}');
        widget.getData = function() {return getProcessCommentsData();};
        widget.validate = function() {return validateProcessComments();};

        widgets.push(widget);
    });

    function getProcessCommentsData() {
        var commentText = $('#process_comments_added_comments').val();
        var data =
        [
           {"key" : "processCommentsAddedComments", "value": JSON.stringify(processCommentsAddedComments), "type" : "comment" }
        ];
        return data;
    }

    function validateProcessComments() {
        var errors = [];
        return errors;
    }

    function process_comments_button_new_click() {
        document.getElementById("process_comments_button_new").style.display="none";
        document.getElementById("process_comments_add_form").style.display="";
        $('#process_comments_body').val("");
    }


    function format_2_digit(value) {
        return ("0" + value).slice(-2);
    }

    function process_comments_button_add_click() {

        var date = new Date();
        var day = date.getDate();
        var twoDigitMonth = format_2_digit(date.getMonth() + 1);
        var year = date.getFullYear();
        var twoDigitYear = date.getFullYear().toString().substr(2,2);

        var time = format_2_digit(date.getHours()) + ":" + format_2_digit(date.getMinutes());
        var fullDate = year + "-" + twoDigitMonth + "-" + day + " " +  time + ":" + date.getSeconds();
        var dateToDisplay = day + "-" + twoDigitMonth + "-" + twoDigitYear + " " +  time;

        var body = $('#process_comments_body').val();
        body = $("<div/>").text(body).html();
        var author = '${user.login}';
        var authorFullName = '${user.realName}';

        if (!body || /^\s*$/.test(body)) {
            return;
        }

        processCommentsAddedComments.push({
            createDate: fullDate,
            body: body,
            authorLogin: author,
            authorFullName: authorFullName
        });

        var text = '<li class="list-group-item">' +
                '<h4 class="list-group-item-heading">'+
                authorFullName + ' (' + author + ')' +
                " [" + dateToDisplay + "] " +
                '</h4><p class="list-group-item-text">'+
                            body+
                        '</p></li>';

        $("#process_comments_list").append(text);

        process_comments_button_cancel_click();
    }

    function process_comments_button_cancel_click() {
        document.getElementById("process_comments_add_form").style.display="none";
        document.getElementById("process_comments_button_new").style.display="";
    }
</script>
</#if>
